# Prompt: Add Email Notifications for Task Events (SCR-008)
# Context: SPECTROPY PMS ‚Äì Admin & User Side
# Goal: Send email notifications on task assignment, updates, and completion
# Tech Stack: React + Node.js + Express + PostgreSQL + Nodemailer/SendGrid + Dev21

---

## üì© Notification Requirements:

1. **Task Assignment**
   - When a task is assigned to a user:
     - Assigned user receives an email notification
     - Email contains: Task title, description, project name, assigned by, due date (if any)
     
2. **Task Completion**
   - When a task is marked completed:
     - Project creator (Admin) receives an email notification
     - Email contains: Task title, completed by, completion date, project name

3. **Task Modification**
   - When a task is updated (title, description, priority, assignee, status):
     - Assigned user **and** project creator (Admin) receive an email notification
     - Email contains: Task title, type of modification, who modified, date/time

---

## üß† Functional Instructions

### Frontend:
- Ensure `TaskCard` and `EditTaskDialog` send API requests with updated data
- Include **assigned user ID** in request body for task creation or update
- Optional: show toast/alert for confirmation of notification sent

### Backend:
1. **API Layer**
   - `POST /api/tasks` ‚Üí After creating a task, trigger `sendEmailNotification` to assigned user
   - `PATCH /api/tasks/:id` ‚Üí After update, trigger `sendEmailNotification` to assigned user and project creator
   - `PATCH /api/tasks/:id/status` ‚Üí If status changed to `completed`, trigger email to project creator

2. **Email Service**
   - Use **Nodemailer or SendGrid**
   - Create reusable function: `sendEmailNotification({to, subject, body})`
   - Ensure async handling and error logging

### Database:
- Add optional columns (if needed):
  - `notificationsEnabled` BOOLEAN (default true) in `users` table
  - Optional: `emailSentAt` TIMESTAMP in `tasks` table for tracking last notification
- Ensure `tasks` table has `assigneeId` and `projectId` relations intact

---

## üé® Frontend Design:

- No UI changes required beyond toast/alerts
- Optionally, show **Email Notification Icon** or last sent time on task card

---

## üîß Dev Notes:

- Ensure **role-based access**: only send admin notifications to project creator
- All notifications must trigger on **server-side**, not client-side
- Handle **failures gracefully**: if email fails, log error, but still update task
- Use **HTML templates** for email for better readability (project branding, task summary, etc.)

---

## üìÅ Folder/File Structure

- `/src/pages/tasks/TaskCard.tsx` ‚Üí trigger notification on assignment or edit
- `/src/pages/tasks/EditTaskDialog.tsx` ‚Üí send API call on task modification
- `/server/routes/tasks.ts` ‚Üí extend POST and PATCH endpoints to trigger emails
- `/server/lib/emailService.ts` ‚Üí central email sending function
- `/server/db/migrations/xxxx_add_notifications_columns.sql` ‚Üí add optional DB columns if needed

---

## ‚úÖ Expected Outcome

- Assigned users receive email when a task is created or modified
- Admin/project creator receives email when assigned task is completed or modified
- Emails include all relevant information: task title, project, who modified/assigned, timestamps
- No UI breakage, all email handling is server-side
